/**
 * Exemplo pr√°tico de uso da feature AI Agent
 * Este arquivo demonstra como usar todas as funcionalidades implementadas
 */

import { AIAgentService } from '../services/ai-agent.service'
import { KnowledgeBaseService } from '../services/knowledge-base.service'
import { EvolutionAPIClient } from '../services/evolution-api.client'

// Configura√ß√µes
const EVOLUTION_BASE_URL = process.env.EVOLUTION_API_URL || 'https://sub.domain.com'
const EVOLUTION_API_KEY = process.env.EVOLUTION_API_KEY || 'your_key'
const INSTANCE_NAME = 'minha-instancia'
const OPENAI_API_KEY = process.env.OPENAI_API_KEY || 'sk-proj-...'

// Exemplo 1: Configura√ß√£o inicial
async function setupInitialConfiguration() {
  console.log('üöÄ Configurando sistema inicial...')

  try {
    // 1. Criar cliente Evolution API
    const evolutionClient = new EvolutionAPIClient(
      EVOLUTION_BASE_URL,
      EVOLUTION_API_KEY,
      INSTANCE_NAME
    )

    // 2. Testar conex√£o
    const isConnected = await evolutionClient.testConnection()
    console.log('‚úÖ Conex√£o Evolution API:', isConnected)

    // 3. Configurar credenciais OpenAI
    const credsResult = await evolutionClient.setOpenAICreds({
      name: 'API Key Principal',
      apiKey: OPENAI_API_KEY
    })
    console.log('‚úÖ Credenciais OpenAI configuradas:', credsResult.data?.id)

    // 4. Configurar settings padr√£o
    const settingsResult = await evolutionClient.setDefaultSettings({
      openaiCredsId: credsResult.data?.id || '',
      expire: 30,
      keywordFinish: '#SAIR',
      delayMessage: 1000,
      unknownMessage: 'Desculpe, n√£o entendi. Pode reformular?',
      listeningFromMe: false,
      stopBotFromMe: true,
      keepOpen: false,
      debounceTime: 10,
      ignoreJids: [],
      openaiIdFallback: credsResult.data?.id || ''
    })
    console.log('‚úÖ Settings padr√£o configurados')

    return credsResult.data?.id
  } catch (error) {
    console.error('‚ùå Erro na configura√ß√£o inicial:', error)
    throw error
  }
}

// Exemplo 2: Criar um agente de vendas
async function createSalesAgent(openaiCredsId: string) {
  console.log('ü§ñ Criando agente de vendas...')

  try {
    const agentService = new AIAgentService(
      EVOLUTION_BASE_URL,
      EVOLUTION_API_KEY,
      INSTANCE_NAME,
      OPENAI_API_KEY
    )

    const agent = await agentService.createAgent({
      name: 'Alex - Assistente de Vendas',
      description: 'Agente especializado em vendas de produtos SaaS',
      instanceName: INSTANCE_NAME,
      openaiCredsId,
      botType: 'chatCompletion',
      model: 'gpt-4o',
      systemMessages: [
        'Voc√™ √© o Alex, um assistente de vendas especializado em produtos SaaS.',
        'Seu objetivo √© ajudar clientes a entenderem nossos produtos e servi√ßos.',
        'Seja sempre prestativo, profissional e honesto.',
        'Nunca fa√ßa promessas sobre pre√ßos ou funcionalidades n√£o confirmadas.',
        'Se n√£o souber algo, diga que vai verificar e retornar em breve.'
      ],
      assistantMessages: [
        'Ol√°! Sou o Alex, seu assistente de vendas. Como posso ajudar voc√™ hoje?'
      ],
      userMessages: [
        'Ol√°, preciso de informa√ß√µes sobre seus produtos'
      ],
      maxTokens: 800,
      triggerType: 'all',
      triggerOperator: 'none',
      expire: 30,
      keywordFinish: '#SAIR',
      delayMessage: 1000,
      unknownMessage: 'Desculpe, n√£o entendi. Pode reformular sua pergunta?',
      listeningFromMe: false,
      stopBotFromMe: true,
      keepOpen: false,
      debounceTime: 10,
      ignoreJids: [],
      persona: {
        name: 'Alex',
        role: 'Assistente de Vendas',
        tone: 'Profissional e amig√°vel',
        expertise: [
          'Vendas SaaS',
          'Produtos digitais',
          'Atendimento ao cliente',
          'Solu√ß√µes empresariais'
        ],
        limitations: [
          'N√£o pode fazer promessas sobre pre√ßos',
          'N√£o pode acessar sistemas internos',
          'N√£o pode processar pagamentos'
        ],
        greeting: 'Ol√°! Sou o Alex, seu assistente de vendas especializado em produtos SaaS. Como posso ajudar voc√™ hoje?',
        fallback: 'Desculpe, n√£o consegui entender sua pergunta. Pode reformular ou usar #SAIR para falar com um humano?'
      },
      knowledgeBase: {
        enabled: true,
        sources: []
      }
    })

    console.log('‚úÖ Agente criado com sucesso:', agent.id)
    return agent
  } catch (error) {
    console.error('‚ùå Erro ao criar agente:', error)
    throw error
  }
}

// Exemplo 3: Configurar base de conhecimento
async function setupKnowledgeBase(agentId: string) {
  console.log('üìö Configurando base de conhecimento...')

  try {
    const knowledgeService = new KnowledgeBaseService(OPENAI_API_KEY)

    // Exemplo de conte√∫do para base de conhecimento
    const productManual = `
    # Manual do Produto SaaS
    
    ## Vis√£o Geral
    Nosso produto √© uma plataforma completa de gest√£o empresarial que inclui:
    - CRM integrado
    - Gest√£o de projetos
    - Controle financeiro
    - Relat√≥rios avan√ßados
    
    ## Funcionalidades Principais
    
    ### CRM
    - Gest√£o de contatos e leads
    - Pipeline de vendas
    - Hist√≥rico de intera√ß√µes
    - Automa√ß√£o de marketing
    
    ### Projetos
    - Cria√ß√£o e gest√£o de projetos
    - Atribui√ß√£o de tarefas
    - Acompanhamento de progresso
    - Gest√£o de tempo
    
    ### Financeiro
    - Controle de receitas e despesas
    - Faturamento autom√°tico
    - Relat√≥rios financeiros
    - Integra√ß√£o banc√°ria
    
    ## Planos e Pre√ßos
    
    ### Starter
    - R$ 99/m√™s
    - At√© 5 usu√°rios
    - Funcionalidades b√°sicas
    
    ### Professional
    - R$ 199/m√™s
    - At√© 20 usu√°rios
    - Todas as funcionalidades
    
    ### Enterprise
    - Pre√ßo sob consulta
    - Usu√°rios ilimitados
    - Suporte dedicado
    `

    // Processar documento e criar chunks com embeddings
    const chunks = await knowledgeService.processDocument(productManual, {
      agentId,
      sourceId: 'product_manual_v1',
      title: 'Manual do Produto',
      category: 'Documenta√ß√£o',
      version: '1.0'
    })

    console.log(`‚úÖ Base de conhecimento configurada com ${chunks.length} chunks`)
    return chunks
  } catch (error) {
    console.error('‚ùå Erro ao configurar base de conhecimento:', error)
    throw error
  }
}

// Exemplo 4: Processar mensagem de cliente
async function processCustomerMessage(agentId: string, customerMessage: string) {
  console.log('üí¨ Processando mensagem do cliente...')

  try {
    const agentService = new AIAgentService(
      EVOLUTION_BASE_URL,
      EVOLUTION_API_KEY,
      INSTANCE_NAME,
      OPENAI_API_KEY
    )

    const response = await agentService.processMessage(agentId, {
      remoteJid: '5511999999999@s.whatsapp.net',
      message: customerMessage,
      type: 'text',
      metadata: {
        generateAudio: false,
        priority: 'normal'
      }
    })

    if (response.success) {
      console.log('‚úÖ Resposta gerada:', response.message)
      return response
    } else {
      console.error('‚ùå Erro ao processar mensagem:', response.error)
      return response
    }
  } catch (error) {
    console.error('‚ùå Erro ao processar mensagem:', error)
    throw error
  }
}

// Exemplo 5: Gerenciar sess√µes
async function manageSessions(agentId: string, openaiBotId: string) {
  console.log('üîê Gerenciando sess√µes...')

  try {
    const agentService = new AIAgentService(
      EVOLUTION_BASE_URL,
      EVOLUTION_API_KEY,
      INSTANCE_NAME,
      OPENAI_API_KEY
    )

    // Buscar sess√µes ativas
    const sessions = await agentService.fetchSessions(openaiBotId)
    console.log('üìã Sess√µes ativas:', sessions.data)

    // Alterar status de uma sess√£o
    const statusResult = await agentService.changeSessionStatus({
      remoteJid: '5511999999999@s.whatsapp.net',
      status: 'paused'
    })
    console.log('‚è∏Ô∏è Status da sess√£o alterado:', statusResult)

    return sessions
  } catch (error) {
    console.error('‚ùå Erro ao gerenciar sess√µes:', error)
    throw error
  }
}

// Exemplo 6: Fluxo completo de atendimento
async function completeCustomerServiceFlow() {
  console.log('üîÑ Iniciando fluxo completo de atendimento...')

  try {
    // 1. Configura√ß√£o inicial
    const openaiCredsId = await setupInitialConfiguration()
    console.log('‚úÖ Configura√ß√£o inicial conclu√≠da')

    // 2. Criar agente
    const agent = await createSalesAgent(openaiCredsId)
    console.log('‚úÖ Agente criado:', agent.name)

    // 3. Configurar base de conhecimento
    const knowledgeChunks = await setupKnowledgeBase(agent.id)
    console.log('‚úÖ Base de conhecimento configurada')

    // 4. Simular mensagens de clientes
    const customerMessages = [
      'Ol√°, preciso de informa√ß√µes sobre seus produtos',
      'Qual √© o pre√ßo do plano Professional?',
      'O plano inclui suporte t√©cnico?',
      'Posso fazer um teste gratuito?'
    ]

    for (const message of customerMessages) {
      console.log(`\nüì® Cliente: ${message}`)
      const response = await processCustomerMessage(agent.id, message)
      console.log(`ü§ñ Alex: ${response.message}`)
      
      // Aguardar um pouco entre mensagens
      await new Promise(resolve => setTimeout(resolve, 2000))
    }

    // 5. Gerenciar sess√µes
    if (agent.evolutionBotId) {
      await manageSessions(agent.id, agent.evolutionBotId)
    }

    console.log('\nüéâ Fluxo de atendimento conclu√≠do com sucesso!')
    return {
      agent,
      knowledgeChunks,
      openaiCredsId
    }
  } catch (error) {
    console.error('‚ùå Erro no fluxo de atendimento:', error)
    throw error
  }
}

// Exemplo 7: Processar √°udio (STT)
async function processAudioMessage(agentId: string, audioUrl: string) {
  console.log('üéµ Processando mensagem de √°udio...')

  try {
    const agentService = new AIAgentService(
      EVOLUTION_BASE_URL,
      EVOLUTION_API_KEY,
      INSTANCE_NAME,
      OPENAI_API_KEY
    )

    const response = await agentService.processMessage(agentId, {
      remoteJid: '5511999999999@s.whatsapp.net',
      message: 'Mensagem de √°udio recebida',
      type: 'audio',
      audioUrl,
      metadata: {
        generateAudio: true, // Gerar resposta em √°udio
        priority: 'high'
      }
    })

    if (response.success) {
      console.log('‚úÖ √Åudio processado:', response.message)
      if (response.audioUrl) {
        console.log('üé§ Resposta em √°udio gerada:', response.audioUrl)
      }
      return response
    } else {
      console.error('‚ùå Erro ao processar √°udio:', response.error)
      return response
    }
  } catch (error) {
    console.error('‚ùå Erro ao processar √°udio:', error)
    throw error
  }
}

// Fun√ß√£o principal para executar todos os exemplos
export async function runAllExamples() {
  console.log('üöÄ Iniciando exemplos da feature AI Agent...\n')

  try {
    const result = await completeCustomerServiceFlow()
    
    console.log('\nüìä Resumo da execu√ß√£o:')
    console.log('- Agente criado:', result.agent.name)
    console.log('- Chunks de conhecimento:', result.knowledgeChunks.length)
    console.log('- Credenciais OpenAI configuradas')
    
    console.log('\n‚úÖ Todos os exemplos executados com sucesso!')
    return result
  } catch (error) {
    console.error('\n‚ùå Erro na execu√ß√£o dos exemplos:', error)
    throw error
  }
}

// Exportar fun√ß√µes individuais para uso espec√≠fico
export {
  setupInitialConfiguration,
  createSalesAgent,
  setupKnowledgeBase,
  processCustomerMessage,
  manageSessions,
  processAudioMessage
}

// Executar se chamado diretamente
if (require.main === module) {
  runAllExamples()
    .then(() => {
      console.log('\nüéØ Exemplos conclu√≠dos!')
      process.exit(0)
    })
    .catch((error) => {
      console.error('\nüí• Erro fatal:', error)
      process.exit(1)
    })
}
